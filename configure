#!/bin/bash

PREFIX=""
CMAKEOPTIONS=""

function printUsageAndExit {
   echo -e "Usage\n" \
           "   Options:\n" \
           "      -p T   Set prefix to T.\n" \
           "      -t     Update translation files (*.ts).\n" \
           "      -v     Verbose compilation.\n" \
           "      -h     Print this help message.\n";
   exit 0;
}

# Ensures cmake exists.
function findCMake {

   if [ -z $(which cmake) ]
   then
      echo "ERROR: cmake not installed";
      exit 1;
   fi

}

findCMake;

# Get options.
while getopts "p:t:h:v" option
do
   case $option in
      p) PREFIX="$OPTARG";;
      t) CMAKEOPTIONS="$CMAKEOPTIONS -DUPDATE_TRANSLATIONS=ON";;
      v) CMAKEOPTIONS="$CMAKEOPTIONS -DCMAKE_VERBOSE_MAKEFILE=TRUE";;
      h) printUsageAndExit ;;
   esac
done

# Cmake defaults CMAKE_INSTALL_PREFIX=/usr/local.
# This is not good for debian, so try to detect debian/ubuntu.
grep -i ubuntu /etc/issue > /dev/null 2> /dev/null || grep -i debian /etc/issue > /dev/null 2> /dev/null
if [ $? == 0 ]
then
   PREFIX=/usr;
fi

echo "Prefix: $PREFIX";

# If we have a prefix...
if [ -z $PREFIX ]
then
   #...define the prefix.
   CMAKEOPTIONS="$CMAKEOPTIONS -DCMAKE_INSTALL_PREFIX=\"$PREFIX\"";
fi

# NOTE: This is an in-source build, which will create lots of extraneous
# files in the source directory. Really, we should probably "cd ../some_empty_directory" and
# then call cmake on the source tree.
cmake $CMAKEOPTIONS .

